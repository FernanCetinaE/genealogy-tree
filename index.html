<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daxcsa Distributor Tree</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Treant.js and dependencies -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.min.js"></script>

  <style>
    /* Chart container: center content and allow scroll */
    #chart {
      width: 100%;
      height: calc(100vh - 104px);
      overflow-x: auto;
      overflow-y: auto;
      padding: 0 0.5rem;
    }

    /* Ensure Treant tree fits its container */
    .Treant {
      max-width: 100%;
    }

    /* Node styling */
    .Treant .node {
      padding: 4px 8px;
      border: 1px solid #4A5568;
      border-radius: 6px;
      background: white;
      font-family: sans-serif;
      font-size: 12px;
    }
    .Treant .node > .node-name {
      background: #2B6CB0;
      color: white;
      padding: 2px 4px;
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      font-weight: 500;
    }
    .Treant .node > .node-content {
      margin-top: 4px;
    }

    /* Breadcrumb container styling */
    #breadcrumb-container {
      background: #f9fafb;
      padding: 8px 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    #breadcrumbs {
      margin-left: 2rem;
      white-space: nowrap;
      overflow-x: auto;
    }

    /* Mobile responsiveness */
    @media (max-width: 640px) {
      #chart {
        padding: 0 0.5rem;
      }
      .Treant .node {
        font-size: 10px;
      }
      #breadcrumbs {
        margin-left: 0.5rem;
      }
      header {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50 flex flex-col h-full">
  <header class="bg-white shadow p-4 flex items-center justify-between flex-wrap">
    <h1 class="text-xl font-semibold">Daxcsa Distributor Tree</h1>
    <div class="flex items-center space-x-4">
      <button id="btn-up" class="px-3 py-1 bg-blue-500 text-white rounded" disabled>Parent</button>
      <button id="btn-top" class="px-3 py-1 bg-blue-500 text-white rounded">Top</button>
      <label for="depth-select">Max Depth:</label>
      <select id="depth-select" class="border border-gray-300 rounded p-1">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3" selected>3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>
  </header>
  <div id="breadcrumb-container">
    <nav id="breadcrumbs" class="text-sm text-gray-600"></nav>
  </div>
  <div id="chart"></div>

  <script>
    let fullData;
    let currentRoot;
    let maxDepth = 3;
    const nodesById = {};
    let renderedNodes = {};

    // Load data
    fetch('Daxcsa.json')
      .then(res => res.json())
      .then(json => {
        fullData = json.data.attributes[0];
        indexNodes(fullData);
        setRoot(fullData);
      });

    function indexNodes(node) {
      nodesById[node.distributor_id] = node;
      if (node.children) node.children.forEach(indexNodes);
    }

    // UI refs
    const btnUp = document.getElementById('btn-up');
    const btnTop = document.getElementById('btn-top');
    const depthSelect = document.getElementById('depth-select');
    const bc = document.getElementById('breadcrumbs');

    btnTop.onclick = () => setRoot(fullData);
    btnUp.onclick = () => {
      const parent = nodesById[currentRoot.parent_id];
      if (parent) setRoot(parent);
    };
    depthSelect.onchange = () => {
      maxDepth = +depthSelect.value;
      renderChart();
    };

    function setRoot(node) {
      currentRoot = node;
      btnUp.disabled = !nodesById[node.parent_id];
      updateBreadcrumbs();
      renderChart();
    }

    function updateBreadcrumbs() {
      const trail = [];
      let cursor = currentRoot;
      while (cursor) {
        trail.push(cursor);
        cursor = nodesById[cursor.parent_id];
      }
      bc.innerHTML = '';
      trail.reverse().forEach((n, idx) => {
        const span = document.createElement('span');
        span.textContent = n.full_name;
        span.className = 'cursor-pointer text-blue-600';
        span.onclick = () => setRoot(n);
        bc.appendChild(span);
        if (idx < trail.length - 1) {
          const sep = document.createElement('span');
          sep.textContent = ' > ';
          bc.appendChild(sep);
        }
      });
    }

    function buildNode(node, depth = 0) {
      const id = 'node-' + node.distributor_id;
      renderedNodes[id] = node;
      // Build custom HTML for each node
      const status = node.status || '-';
      const product = node.product_name || '-';
      const category = node.category_name || '-';
      const html = `
        <div class="node-name">${node.full_name}</div>
        <div class="node-content">
          <div><strong>U:</strong> ${node.username}</div>
          <div><strong>S:</strong> ${status}</div>
          <div><strong>P:</strong> ${product}</div>
          <div><strong>C:</strong> ${category}</div>
        </div>
      `;
      const obj = {
        HTMLid: id,
        innerHTML: html
      };
      if (depth + 1 < maxDepth && node.children) {
        const children = [];
        ['Left', 'Right'].forEach(side => {
          const child = node.children.find(c => c.binary_placement === side);
          if (child) children.push(buildNode(child, depth + 1));
        });
        if (children.length) obj.children = children;
      }
      return obj;
    }

    function renderChart() {
      renderedNodes = {};
      document.getElementById('chart').innerHTML = '';

      // Determine spacing based on viewport
      const isMobile = window.innerWidth < 640;
      const levelSep = isMobile ? 70 : 50;
      const siblingSep = isMobile ? 40 : 20;
      const subSeparation = isMobile ? 40 : 30;

      const config = {
        chart: {
          container: '#chart',
          levelSeparation: levelSep,
          siblingSeparation: siblingSep,
          subTeeSeparation: subSeparation,
          connectors: { type: 'curve' }
        },
        nodeStructure: buildNode(currentRoot)
      };

      new Treant(config, attachNodeHandlers);(config, attachNodeHandlers);
    }

    window.addEventListener('resize', () => {
      if (currentRoot) renderChart();
    });

    function attachNodeHandlers() {
      Object.entries(renderedNodes).forEach(([id, node]) => {
        const el = document.getElementById(id);
        if (el) {
          el.style.cursor = 'pointer';
          el.onclick = () => setRoot(node);
        }
      });
    }
  </script>
</body>
</html>
